<!DOCTYPE html>  
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miyagi - Interview Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #0f202c;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #f8f8f8;
            margin-bottom: 10px;
            font-size: 3em;
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        .header p {
            color: #f8f8f8;
            font-size: 1.2em;
            font-weight: 300;
        }
        
        .chat-container {
            min-height: 80px;
            max-height: 500px;
            background: #2d2b27f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .chat-container.expanded {
            min-height: 300px;
        }
        
        .message {
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            animation: fadeIn 0.6s ease-out;
            line-height: 1.6;
        }
        
        .message:first-child {
            margin-top: 0;
        }
        
        .message:last-child {
            margin-bottom: 0;
        }
        
        .message.miyagi {
            background: #2d2b27f0;
            border-left: 2px solid #6b7280;
        }
        
        .message.user {
            background: #3a3a3a;
            border-left: 3px solid #9ca3af;
        }
        
        .message.question {
            background: #2d2d2d;
            border-left: 3px solid #6b7280;
            font-weight: 400;
        }
        
        .message.feedback {
            background: #2d2d2d;
            border-left: 3px solid #6b7280;
        }
        
        .message strong {
            color: #e0e0e0;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s ease;
            background: #2d2b27f0;
            color: #e0e0e0;
            border: 1px solid #6b7280;
            min-width: 140px;
        }
        
        .btn:hover {
            background: #5a5a5a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #3a3a3a;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: #9ca3af;
            font-size: 1.1em;
        }
        
        .loading-dots {
            display: inline-block;
            animation: loadingDots 1.5s infinite;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        .listening {
            background: #6b7280 !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.02);
                opacity: 1;
            }
        }

        .speech-status {
            text-align: center;
            margin-top: 10px;
            color: #9ca3af;
            font-size: 0.9em;
        }

        /* Scrollbar styling */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Mobile responsiveness */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        .browser-warning {
            background: #dc2626;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Miyagi</h1>
            <p>Personal Interview Coach</p>
        </div>

        <div id="browserWarning" class="browser-warning">
            <strong>Speech Recognition Issue:</strong> This feature requires microphone permissions and a supported browser (Chrome, Edge, Safari). 
            <br><small>Make sure you're using HTTPS or localhost, and click "Allow" when prompted for microphone access.</small>
        </div>
        
        <div id="chat" class="chat-container">
            <div class="message miyagi">
                <strong>Miyagi:</strong> Welcome! Click "Start Interview" to begin your practice session.
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startInterview()">Start Interview</button>
            <button class="btn" id="voiceBtn" onclick="startVoiceInput()" style="display: none;">
                Answer
            </button>
            <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">Next Question</button>
            <button class="btn" id="resetBtn" onclick="resetSession()" style="display: none;">Reset</button>
        </div>
        
        <div class="speech-status" id="speechStatus"></div>
        
        <div id="loading" class="loading">
            <p>Thinking...<span class="loading-dots"></span></p>
        </div>
    </div>

    <script>
        let isRecording = false;
        let currentState = -1;
        let messageCount = 0;
        let recognition = null;
        let speechSupported = false;

        // Check if page is served over HTTPS or localhost
        function isSecureContext() {
            return window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.hostname === '';
        }

        // Initialize speech recognition with comprehensive diagnostics
        function initSpeechRecognition() {
            console.log('Initializing speech recognition...');
            console.log('Browser:', navigator.userAgent);
            console.log('Protocol:', window.location.protocol);
            console.log('Hostname:', window.location.hostname);
            
            // Check HTTPS requirement
            if (!isSecureContext()) {
                console.error('Speech recognition requires HTTPS or localhost');
                addMessage('System', 'Speech recognition requires a secure connection (HTTPS). Please access this page via HTTPS or localhost.');
                showBrowserWarning();
                return false;
            }
            
            try {
                // Check for speech recognition support with detailed logging
                console.log('Checking for SpeechRecognition support...');
                console.log('window.SpeechRecognition:', typeof window.SpeechRecognition);
                console.log('window.webkitSpeechRecognition:', typeof window.webkitSpeechRecognition);
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    console.log('Speech recognition not supported in this browser');
                    addMessage('System', 'Speech recognition is not supported in this browser. Try Chrome, Edge, or Safari.');
                    showBrowserWarning();
                    return false;
                }
                
                console.log('Creating SpeechRecognition instance...');
                recognition = new SpeechRecognition();
                
                // Configure recognition settings
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                console.log('Recognition configured with settings:', {
                    continuous: recognition.continuous,
                    interimResults: recognition.interimResults,
                    lang: recognition.lang,
                    maxAlternatives: recognition.maxAlternatives
                });
                
                recognition.onstart = function() {
                    console.log('Speech recognition started successfully');
                    document.getElementById('speechStatus').textContent = 'Listening... Speak clearly into your microphone.';
                    isRecording = true;
                };
                
                recognition.onresult = function(event) {
                    console.log('Speech recognition result received');
                    console.log('Event results:', event.results);
                    
                    if (event.results.length > 0) {
                        const transcript = event.results[0][0].transcript.trim();
                        const confidence = event.results[0][0].confidence;
                        
                        console.log('Transcript:', transcript, 'Confidence:', confidence);
                        
                        if (transcript.length > 0) {
                            addMessage('You', transcript);
                            
                            // Send transcript to server for feedback
                            showLoading(true);
                            fetch('/process_speech_text', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({text: transcript})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    addMessage('System', 'Error: ' + data.error);
                                } else {
                                    addMessage('Miyagi', data.response, 'feedback');
                                    currentState = data.state;
                                    updateButtonVisibility();
                                }
                                showLoading(false);
                            })
                            .catch(error => {
                                console.error('Error processing speech:', error);
                                addMessage('System', 'Error processing speech: ' + error.message);
                                showLoading(false);
                            });
                        } else {
                            addMessage('System', 'No speech detected. Please try again.');
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    console.error('Full error event:', event);
                    
                    let errorMessage = 'Speech recognition error: ';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage += 'No speech detected. Please try speaking more clearly.';
                            break;
                        case 'audio-capture':
                            errorMessage += 'Microphone not found or not working. Please check your microphone.';
                            break;
                        case 'not-allowed':
                            errorMessage += 'Microphone permission denied. Please click the microphone icon in your browser\'s address bar and allow access.';
                            break;
                        case 'network':
                            errorMessage += 'Network error. Please check your internet connection.';
                            break;
                        case 'service-not-allowed':
                            errorMessage += 'Speech service not allowed. This may be due to browser security settings or network restrictions.';
                            break;
                        case 'bad-grammar':
                            errorMessage += 'Grammar error in speech recognition.';
                            break;
                        case 'language-not-supported':
                            errorMessage += 'Language not supported.';
                            break;
                        default:
                            errorMessage += `${event.error}. Please try again or use a different browser.`;
                    }
                    
                    addMessage('System', errorMessage);
                    document.getElementById('speechStatus').textContent = '';
                };
                
                recognition.onend = function() {
                    console.log('Speech recognition ended');
                    isRecording = false;
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.innerHTML = 'Answer';
                    voiceBtn.classList.remove('listening');
                    voiceBtn.disabled = false;
                    document.getElementById('speechStatus').textContent = '';
                };
                
                // Test if we can create the recognition object
                console.log('Speech recognition initialized successfully');
                speechSupported = true;
                return true;
                
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                addMessage('System', `Failed to initialize speech recognition: ${error.message}`);
                showBrowserWarning();
                return false;
            }
        }

        function showBrowserWarning() {
            document.getElementById('browserWarning').style.display = 'block';
        }

        function addMessage(sender, content, type = '') {
            const chatContainer = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender.toLowerCase()} ${type}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${content}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Expand chat container after first user interaction
            messageCount++;
            if (messageCount > 1) {
                chatContainer.classList.add('expanded');
            }
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = show ? 'block' : 'none';
        }

        function updateButtonVisibility() {
            const startBtn = document.getElementById('startBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const nextBtn = document.getElementById('nextBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            // Reset state: show only start button
            if (currentState === 0) {
                startBtn.style.display = 'inline-block';
                voiceBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                resetBtn.style.display = 'none';
            } 
            // After feedback: show next question and reset
            else if (currentState === -1) {
                startBtn.style.display = 'none';
                voiceBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
            } 
            // After question: show answer and reset
            else if (currentState === 1) {
                startBtn.style.display = 'none';
                voiceBtn.style.display = speechSupported ? 'inline-block' : 'none';
                nextBtn.style.display = 'none';
                resetBtn.style.display = 'inline-block';
                
                if (!speechSupported) {
                    addMessage('System', 'Speech recognition is not available. Please type your answer or try a different browser.');
                }
            }
        }

        async function startInterview() {
            showLoading(true);
            try {
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                addMessage('Miyagi', data.message, 'question');
                currentState = data.state;
                updateButtonVisibility();
            } catch (error) {
                console.error('Error starting interview:', error);
                addMessage('System', 'Error starting interview: ' + error.message);
            }
            showLoading(false);
        }

        async function nextQuestion() {
            showLoading(true);
            try {
                const response = await fetch('/next_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                addMessage('Miyagi', data.response, 'question');
                currentState = data.state;
                updateButtonVisibility();
            } catch (error) {
                console.error('Error getting next question:', error);
                addMessage('System', 'Error getting next question: ' + error.message);
            }
            showLoading(false);
        }

        function startVoiceInput() {
            console.log('Starting voice input...');
            console.log('Current recording state:', isRecording);
            console.log('Current app state:', currentState);
            console.log('Speech supported:', speechSupported);
            
            if (isRecording) {
                console.log('Already recording, ignoring request');
                return;
            }
            
            // Check if we're in the correct state for voice input
            if (currentState !== 1) {
                addMessage('System', 'Voice input is only available after a question is asked.');
                return;
            }
            
            if (!recognition || !speechSupported) {
                addMessage('System', 'Speech recognition is not supported in this browser. Please try Chrome, Firefox, Safari, or Edge.');
                return;
            }
            
            // Check for microphone permissions first
            console.log('Checking microphone permissions...');
            
            // Try to get microphone permission using different methods
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('Using navigator.mediaDevices.getUserMedia');
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('Microphone access granted');
                        // Stop the stream immediately after getting permission
                        stream.getTracks().forEach(track => {
                            console.log('Stopping track:', track);
                            track.stop();
                        });
                        
                        startSpeechRecognition();
                    })
                    .catch(function(error) {
                        console.error('Microphone access error:', error);
                        handleMicrophoneError(error);
                    });
            } else {
                console.log('getUserMedia not available, trying direct speech recognition');
                // Fallback: try speech recognition directly
                startSpeechRecognition();
            }
        }
        
        function handleMicrophoneError(error) {
            let errorMessage = 'Microphone access error: ';
            
            switch(error.name) {
                case 'NotAllowedError':
                    errorMessage += 'Permission denied. Please click the microphone icon in your browser\'s address bar and allow access, then try again.';
                    break;
                case 'NotFoundError':
                    errorMessage += 'No microphone found. Please check that a microphone is connected.';
                    break;
                case 'NotReadableError':
                    errorMessage += 'Microphone is already in use by another application.';
                    break;
                default:
                    errorMessage += error.message || 'Unknown error. Please try again.';
            }
            
            addMessage('System', errorMessage);
        }
        
        function startSpeechRecognition() {
            console.log('Starting speech recognition...');
            
            // Update button state
            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = 'Listening...';
            voiceBtn.classList.add('listening');
            voiceBtn.disabled = true;
            
            // Start speech recognition with error handling
            try {
                console.log('Calling recognition.start()...');
                recognition.start();
                console.log('Recognition.start() called successfully');
            } catch (error) {
                console.error('Error starting recognition:', error);
                addMessage('System', 'Error starting speech recognition: ' + error.message + '. Try refreshing the page.');
                
                // Reset button state
                voiceBtn.innerHTML = 'Answer';
                voiceBtn.classList.remove('listening');
                voiceBtn.disabled = false;
            }
        }

        async function resetSession() {
            showLoading(true);
            try {
                const response = await fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                const chatContainer = document.getElementById('chat');
                chatContainer.innerHTML = `
                    <div class="message miyagi">
                        <strong>Miyagi:</strong> Session reset! Click "Start Interview" to begin your practice session.
                    </div>
                `;
                chatContainer.classList.remove('expanded');
                messageCount = 1;
                currentState = 0; // Set to initial state, not -1
                updateButtonVisibility();
            } catch (error) {
                console.error('Reset error:', error);
                addMessage('System', 'Reset error: ' + error.message);
            }
            showLoading(false);
        }

        // Initialize the interface
        window.onload = function() {
            currentState = 0; // Initial state
            messageCount = 1;
            updateButtonVisibility();
            
            // Initialize speech recognition
            if (!initSpeechRecognition()) {
                console.log('Speech recognition not supported');
                document.getElementById('speechStatus').textContent = 'Speech recognition not supported in this browser';
            } else {
                console.log('Speech recognition initialized successfully');
            }
        };
    </script>
</body>
</html>